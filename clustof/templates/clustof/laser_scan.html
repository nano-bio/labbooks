{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'dygraph/dygraph.min.css' %}">
    <link rel="stylesheet" href="{% static 'jquery.toast/jquery.toast.min.css' %}">
    {#    {% include 'massspectra/mass_spectra_viewer_style.html' %}#}
    <style>
        .row {
            min-height: 550px
        }

        #laser-scan-div {
            position: absolute;
            inset: 5px;
        }

        .dygraph-legend {
            left: 70px !important;
            background-color: transparent !important;
            width: 100%;
            font-size: large;
        }

        .spinner {
            display: none;
            position: absolute;
            top: 20%;
            left: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .spinner div {
            margin: 20px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <h4 class="mt-4 mb-2 text-center">Laser-Scan Viewer for ClusTOF Measurement ID {{ measurement_id }}</h4>

        <div class="row">
            <div class="col position-relative">
{#            <div class="col-7 col-md-8 col-lg-9 col-xl-10 position-relative">#}
                <div id="laser-scan-div"></div>
                <div id="spinner-laser-scan" class="spinner">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="col-auto">
{#            <div class="col-5 col-md-4 col-lg-3 col-xl-2">#}
                <form>
                    <fieldset>
                        <div class="mb-3">
                            <label for="laser-scan-input-mass" class="form-label">Mass</label>
                            <select id="laser-scan-input-mass" class="form-select">
                                {% for mass in mass_list %}
                                    <option value="{{ forloop.counter0 }}">{{ mass }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="laser-scan-input-mode" class="form-label">Mode</label>
                            <select id="laser-scan-input-mode" class="form-select">
                                <option value="/">Division</option>
                                <option value="-">Subtraction</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="laser-scan-input-x-start" class="form-label">X Start</label>
                            <input class="form-control" type="number" step="0.1" id="laser-scan-input-x-start">
                        </div>
                        <div class="mb-3">
                            <label for="laser-scan-input-x-end" class="form-label">X End</label>
                            <input class="form-control" type="number" step="0.1" id="laser-scan-input-x-end">
                        </div>
                        <div class="form-text mt-0" style="max-width: 205px">
                            If you select a start and end I create a linear x-axis for you. Otherwise x-axis is only the
                            number of data points.
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'dygraph/dygraph.min.js' %}"></script>
    <script src="{% static 'jquery.toast/jquery.toast.min.js' %}"></script>
    <script>
      $.ajaxSetup({
        beforeSend: function (xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        }
      });
      const spinnerLS = $('#spinner-laser-scan')

      const gL = new Dygraph(
        document.getElementById("laser-scan-div"), [[0, 0]], {
          legend: 'always',
          labels: ['laser-related', 'ID {{ measurement_id }}']
        });

      $(":input").change(function () {
        plotLaserScan();
      })

      function plotLaserScan() {
        spinnerLS.show('slow');

        let massColumn = $('#laser-scan-input-mass').val();
        let mode = $('#laser-scan-input-mode').val();
        let xStart = $('#laser-scan-input-x-start').val();
        let xEnd = $('#laser-scan-input-x-end').val();

        let url = "{% url 'clustof-laser-scan-data' %}";
        $.post(url, {
          massColumn: massColumn,
          mode: mode,
          measurementId: {{ measurement_id }},
          xStart: xStart,
          xEnd: xEnd
        }).done(function (data) {
          gL.updateOptions({'file': data.data});
        }).fail(function () {
          $.toast({
            heading: 'Error',
            text: 'Something went wrong',
            showHideTransition: 'fade',
            icon: 'warning'
          })
        }).always(function () {
          spinnerLS.hide();
        });
      }
    </script>
{% endblock %}